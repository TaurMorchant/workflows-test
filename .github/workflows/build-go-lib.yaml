# ------------------------------------------------------------------------------
# Workflow: Generic build
#
# Purpose:
#   Reusable workflow to build/test Go libs and run SonarCloud analysis
#
# Trigger:
#   - workflow_call with inputs:
#       sonar-project-key (optional) : SonarCloud project key
#       go-module-dir     (optional) : directory with go.mod
#       actor             (required) : GitHub actor triggering the run
#     and secret:
#       sonar-token (required) : SonarCloud token
#
# Logic:
#   1. check-pr:
#        - Detects if an open PR exists for the branch.
#        - If push to a branch with an open PR â†’ skip and delegate to PR workflow.
#   2. go-build:
#        - Runs if not delegated.
#        - Builds/tests Go module and runs SonarCloud analysis.
#
# Permissions: contents: read, pull-requests: write
# Concurrency: one run per branch/event, older runs canceled
# ------------------------------------------------------------------------------

name: Generic build

on:
  workflow_call:
    inputs:
      sonar-project-key:
        description: 'Sonar project key for analysis. It must be specified explicitly, as the qubership-core-infra repository may have its own sonar-project-key. '
        required: false
        type: string
      go-module-dir:
        description: 'Optional directory containing go.mod file. If not specified, will search for go.mod files in the repository.'
        required: false
        type: string
      actor:
        description: 'GitHub actor (user or bot) that triggered the workflow'
        required: true
        type: string
    secrets:
      sonar-token:
        required: true

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ci-${{ github.event_name }}-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  check-pr:
    name: Check is PR exists
    runs-on: ubuntu-latest
    outputs:
      hasOpenPr: ${{ steps.pr.outputs.hasOpenPr }}
    steps:
      - name: Check for open PR
        id: pr
        uses: taurmorchant/workflows-test/.github/actions/check-open-pr@main

      - name: Explain routing decision
        if: ${{ github.event_name == 'push' && steps.pr.outputs.hasOpenPr == 'true' }}
        run: |
          {
            echo "### Router decision"
            echo ""
            echo "- Event: \`${{ github.event_name }}\`"
            echo "- Branch: \`${{ github.head_ref || github.ref_name }}\`"
            echo "- Open PR detected: **yes**"
            echo ""
            echo "Work is delegated to the PR workflow. Skip next steps."
          } >> "$GITHUB_STEP_SUMMARY"

  go-build:
    name: Build and test Go module
    needs: [ check-pr ]
    if: ${{ !(github.event_name == 'push' && needs.check-pr.outputs.hasOpenPr == 'true') }}
    uses: taurmorchant/workflows-test/.github/workflows/go-build-with-sonar.yaml@main
    with:
      actor: ${{ inputs.actor }}
      go-module-dir: ${{ inputs.go-module-dir }}
      sonar-project-key: ${{ inputs.sonar-project-key }}
    secrets:
      sonar-token: ${{ secrets.sonar-token }}